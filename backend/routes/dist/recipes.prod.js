"use strict";function ownKeys(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,r)}return o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(o,!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(o).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var express=require("express"),multer=require("multer"),Recipe=require("../models/recipe"),checkAuth=require("../middleware/check-auth"),router=express.Router(),MIME_TYPE_MAP={"image/png":"png","image/jpg":"jpg","image/jpeg":"jpg"},storage=multer.diskStorage({destination:function(e,t,o){var r=MIME_TYPE_MAP[t.mimetype];new Error("invalid mime type");o(null,"backend/images")},filename:function(e,t,o){var r=t.originalname.toLowerCase().split(" ").join("-"),n=MIME_TYPE_MAP[t.mimetype];o(null,r+"-"+Date.now()+"."+n)}});router.post("",checkAuth,multer({storage:storage}).single("image"),function(e,t,o){var r=e.protocol+"://"+e.get("host");console.log(e.file);var n=new Recipe({title:e.body.title,description:e.body.description,isVegan:"true"===e.body.isVegan,imagePath:r+"/images/"+e.file.filename,creatorData:e.userData.userId});console.log("\nthis recipe will be added to db: "),console.log(n),n.save().then(function(e){t.status(201).json({message:"recipe added sucessfuly",recipe:_objectSpread({},e,{id:e._id})})})}),router.put("/:id",checkAuth,multer({storage:storage}).single("image"),function(e,t,o){console.log(e);var r=e.body.imagePath;e.file&&(r=e.protocol+"://"+e.get("host")+"/images/"+e.file.filename);console.log("s================");var n=new Recipe({_id:e.body.id,title:e.body.title,description:e.body.description,imagePath:r,isVegan:e.body.isVegan,creatorData:e.userData.userId});Recipe.updateOne({_id:e.params.id,creatorData:e.userData.userId},n).then(function(e){console.log(e),0<e.n?t.status(200).json({message:"post updated :)"}):(console.log("not auth"),t.status(401).json({message:"not auth!"}))})}),router.get("",function(e,t,o){Recipe.find().populate("creatorData").then(function(e){console.log("recipes fetcheddd!!! :)"),t.status(200).json({message:"recipes fetched succesfully :)",recipes:e})}).catch(function(e){console.log("could not fetch recipes!")})}),router.get("/:id",function(e,t,o){Recipe.findById(e.params.id).populate("creatorData").then(function(e){e?t.status(200).json(e):t.status(404).json({message:"recipe not found :("})})}),router.delete("/:id",checkAuth,function(e,t,o){Recipe.deleteOne({_id:e.params.id,creatorData:e.userData.userId}).then(function(e){0<e.n?(t.status(200).json({message:"recipe deleted! :)"}),console.log("recipe deleted!")):t.status(401).json({message:"not auth"})}).catch(function(e){console.log(e),t.status(404).json({message:"an error occured",error:e})})}),module.exports=router;